<!DOCTYPE HTML><html><head><meta name="generator" content="Hexo 3.8.0"><meta charset="utf-8"><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><title>JSR269插件化注解API | WhatAKitty Daily | A Programmer&#39;s Daily Record</title><meta name="author" content="WhatAKitty"><meta name="description" content="Just A Simple Programmer."><meta name="keywords" content="jsr,jsr269,annotation,jsr175,AbstractProcessor,lombok,jvm,RoundEnvironment,java,Blog, SSL, Nodejs, DevOps, Spring, Spring Cloud, Jenkins, Docker, JIRA, CI"><meta id="viewport" name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,minimum-scale=1,user-scalable=no,minimal-ui"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="black"><meta property="og:title" content="JSR269插件化注解API"><meta property="og:site_name" content="WhatAKitty Daily"><meta property="og:image" content="/favicon.ico"><link href="/favicon.ico" rel="icon"><link rel="alternate" href="/atom.xml" title="WhatAKitty Daily" type="application/atom+xml"><link rel="stylesheet" href="/css/style.css" media="screen" type="text/css"></head><body><div class="blog"><div class="content"><header><div class="site-branding"><h1 class="site-title"><a href="/">WhatAKitty Daily</a></h1><p class="site-description">A Programmer&#39;s Daily Record</p></div><nav class="site-navigation"><ul><li><a href="/">主页</a></li><li><a href="/archives">归档</a></li><li><a href="/projects">项目</a></li><li><a href="/categories/JavaSources">Java Sources</a></li><li><a href="/categories/Java/Spring/SpringSources">Spring Sources</a></li><li><a href="/atom.xml">订阅</a></li></ul></nav></header><main class="site-main posts-loop"><article><h3 class="article-title"><span>JSR269插件化注解API</span></h3><div class="article-top-meta"><span class="posted-on"><a href="/JSR269插件化注解API.html" rel="bookmark">WhatAKitty &emsp; <time class="entry-date published" datetime="2019-05-07T15:41:47.000Z">2019-05-07 </time>&emsp; <span id="busuanzi_container_page_pv">阅读次数<span id="busuanzi_value_page_pv">loading...</span></span></a></span></div><div class="article-content"><div class="entry"><h3 id="&#x80CC;&#x666F;"><a href="#&#x80CC;&#x666F;" class="headerlink" title="&#x80CC;&#x666F;"></a>&#x80CC;&#x666F;</h3><p>&#x4E00;&#x76F4;&#x5728;&#x4F7F;&#x7528;Lombok&#x4EE5;&#x53CA;MapStruct&#xFF0C;&#x4F46;&#x662F;&#x5BF9;&#x4E8E;&#x5B83;&#x4EEC;&#x80FD;&#x591F;&#x5728;&#x7F16;&#x8BD1;&#x9636;&#x6BB5;&#x76F4;&#x63A5;&#x751F;&#x6210;&#x5B9E;&#x4F8B;&#x4EE3;&#x7801;&#x5374;&#x6CA1;&#x6709;&#x4ED4;&#x7EC6;&#x4E86;&#x89E3;&#x8FC7;&#x3002;&#x6700;&#x8FD1;&#x521A;&#x597D;&#x5728;&#x90E8;&#x95E8;&#x5185;&#x505A;&#x4E86;&#x4E00;&#x6B21;&#x5206;&#x4EAB;&#xFF0C;&#x4E5F;&#x5728;&#x8FD9;&#x91CC;&#x5BF9;&#x5177;&#x4F53;&#x539F;&#x7406;&#x505A;&#x4E00;&#x4E2A;&#x8BE6;&#x7EC6;&#x9610;&#x8FF0;&#x3002;</p><a id="more"></a><h3 id="Lombok&#x4EE5;&#x53CA;MapStruct&#x5B9E;&#x73B0;&#x5927;&#x4F53;&#x601D;&#x8DEF;"><a href="#Lombok&#x4EE5;&#x53CA;MapStruct&#x5B9E;&#x73B0;&#x5927;&#x4F53;&#x601D;&#x8DEF;" class="headerlink" title="Lombok&#x4EE5;&#x53CA;MapStruct&#x5B9E;&#x73B0;&#x5927;&#x4F53;&#x601D;&#x8DEF;"></a>Lombok&#x4EE5;&#x53CA;MapStruct&#x5B9E;&#x73B0;&#x5927;&#x4F53;&#x601D;&#x8DEF;</h3><p>Lombok&#x4EE5;&#x53CA;MapStruct&#x90FD;&#x662F;&#x901A;&#x8FC7;&#x5728;&#x76EE;&#x6807;&#x4EE3;&#x7801;&#x4E0A;&#x6807;&#x8BB0;&#x6CE8;&#x89E3;&#xFF0C;&#x7F16;&#x8BD1;&#x5668;&#x80FD;&#x591F;&#x6839;&#x636E;&#x6CE8;&#x89E3;&#x751F;&#x6210;&#x5BF9;&#x5E94;&#x7684;&#x5B9E;&#x73B0;&#x4EE3;&#x7801;&#x3002;&#x6BD4;&#x5982;Lombok&#x5728;&#x5C5E;&#x6027;&#x4E0A;&#x6807;&#x8BB0;<code>@Getter</code>&#xFF0C;&#x90A3;&#x4E48;&#x5728;&#x8FD9;&#x4E2A;<code>Java Bean</code>&#x5185;&#x5C31;&#x4F1A;&#x751F;&#x6210;&#x5BF9;&#x5E94;&#x5C5E;&#x6027;&#x7684;<code>get</code>&#x65B9;&#x6CD5;&#x3002;</p><p>&#x672C;&#x8D28;&#x4E0A;&#x6765;&#x8BF4;&#xFF0C;&#x4E0D;&#x7BA1;&#x662F;Lombok&#x6216;&#x8005;MapStruct&#xFF0C;&#x90FD;&#x662F;&#x901A;&#x8FC7;Java&#x7684;&#x4E00;&#x4E2A;&#x6807;&#x51C6;API&#x6765;&#x5B9E;&#x73B0;&#x7684;&#xFF1B;&#x8FD9;&#x4E2A;API&#x5373;&#x4E3A;<code>Pluggable Annotation Processing API</code>&#xFF0C;&#x7B80;&#x79F0;&#x4E3A;JSR269&#x3002;</p><h3 id="JSR269"><a href="#JSR269" class="headerlink" title="JSR269"></a>JSR269</h3><p>&#x501F;&#x7528;JSR269&#x5B98;&#x65B9;&#x539F;&#x6587;&#x5B9A;&#x4E49;&#xFF08;&#x9644;&#x5E26;&#x539F;&#x6587;&#x5730;&#x5740;&#xFF1A;<a href="https://jcp.org/en/jsr/detail?id=269&#xFF09;&#xFF1A;" target="_blank" rel="noopener">https://jcp.org/en/jsr/detail?id=269&#xFF09;&#xFF1A;</a></p><blockquote><p>J2SE 1.5 added a new Java language mechanism &#x201C;annotations&#x201D; that allows annotation types to be used to annotate classes, fields, and methods. These annotations are typically processed either by build-time tools or by run-time libraries to achieve new semantic effects. In order to support annotation processing at build-time, this JSR will define APIs to allow annotation processors to be created using a standard pluggable API. This will simplify the task of creating annotation processors and will also allow automation of the discovery of appropriate annotation processors for a given source file.<br>The specification will include at least two sections, a section of API modeling the Java programming language and a distinct section for declaring annotation processors and controlling how they are run. Since annotations are placed on program elements, an annotation processing framework needs to reflect program structure. Annotation processors will be able to specify what annotations they process and multiple processors will be able to run cooperatively.<br>The processors and program structure api can be accessed at build-time; i.e. this functionality supplements core reflection support for reading annotations.</p></blockquote><p>&#x8BD1;&#x6587;&#x5982;&#x4E0B;&#xFF1A;</p><blockquote><p>J2SE 1.5 &#x589E;&#x52A0;&#x4E86;&#x4E00;&#x79CD;&#x65B0;&#x7684;Java&#x8BED;&#x8A00;&#x673A;&#x5236;&#x201D;annotations&#x201C;&#xFF0C;&#x5B83;&#x5141;&#x8BB8;&#x6CE8;&#x89E3;&#x88AB;&#x7528;&#x4E8E;&#x7C7B;&#x3001;&#x5B57;&#x6BB5;&#x4EE5;&#x53CA;&#x65B9;&#x6CD5;&#x4E0A;&#x3002;&#x8FD9;&#x4E9B;&#x6CE8;&#x89E3;&#x7531; <code>build-time</code> &#x5DE5;&#x5177;&#x4EE5;&#x53CA; <code>run-time</code> &#x5E93;&#x5904;&#x7406;&#xFF0C;&#x6765;&#x8FBE;&#x5230;&#x65B0;&#x7684;&#x8BED;&#x4E49;&#x6548;&#x679C;&#x3002;&#x4E3A;&#x4E86;&#x652F;&#x6301;&#x5728; <code>build-time</code> &#x65F6;&#x5904;&#x7406;&#x6CE8;&#x89E3;&#xFF0C;&#x8FD9;&#x4E2A;JSR&#x5B9A;&#x4E49;&#x4E86;&#x901A;&#x7528;&#x7684;&#x63D2;&#x5165;&#x5F0F;API&#x7528;&#x4E8E;&#x521B;&#x5EFA;&#x6807;&#x51C6;&#x7684;&#x6CE8;&#x89E3;&#x5904;&#x7406;&#x5668;&#x3002;&#x8FD9;&#x5C06;&#x7B80;&#x5316;&#x521B;&#x5EFA;&#x6CE8;&#x89E3;&#x5904;&#x7406;&#x5668;&#x7684;&#x4EFB;&#x52A1;&#xFF0C;&#x5E76;&#x4E14;&#x8FD8;&#x80FD;&#x591F;&#x6839;&#x636E;&#x6E90;&#x6587;&#x4EF6;&#x81EA;&#x52A8;&#x5339;&#x914D;&#x54CD;&#x5E94;&#x7684;&#x6CE8;&#x89E3;&#x5904;&#x7406;&#x5668;&#x3002;<br>&#x8BE5;&#x89C4;&#x8303;&#x5C06;&#x81F3;&#x5C11;&#x5305;&#x542B;&#x4E24;&#x4E2A;&#x90E8;&#x5206;&#xFF0C;&#x4E00;&#x90E8;&#x5206;&#x7528;&#x4E8E;&#x5EFA;&#x6A21;Java&#x7F16;&#x7A0B;&#x8BED;&#x8A00;&#x7684;API&#xFF0C;&#x53E6;&#x4E00;&#x90E8;&#x5206;&#x7528;&#x4E8E;&#x58F0;&#x660E;&#x6CE8;&#x89E3;&#x5904;&#x7406;&#x5668;&#x4EE5;&#x53CA;&#x4ED6;&#x4EEC;&#x7684;&#x8FD0;&#x4F5C;&#x673A;&#x5236;&#x3002;&#x7531;&#x4E8E;&#x6CE8;&#x89E3;&#x88AB;&#x7528;&#x4E8E;&#x7A0B;&#x5E8F;&#x5143;&#x7D20;&#x4E0A;&#xFF0C;&#x4E00;&#x4E2A;&#x6CE8;&#x89E3;&#x5904;&#x7406;&#x6846;&#x67B6;&#x9700;&#x8981;&#x53CD;&#x6620;&#x7A0B;&#x5E8F;&#x7ED3;&#x6784;&#x3002;&#x6CE8;&#x89E3;&#x5904;&#x7406;&#x5668;&#x5C06;&#x80FD;&#x6307;&#x5B9A;&#x54EA;&#x4E9B;&#x6CE8;&#x89E3;&#x662F;&#x5B83;&#x4EEC;&#x53EF;&#x4EE5;&#x5904;&#x7406;&#x7684;&#xFF0C;&#x4EE5;&#x53CA;&#x591A;&#x4E2A;&#x6CE8;&#x89E3;&#x5904;&#x7406;&#x5668;&#x5982;&#x4F55;&#x534F;&#x540C;&#x5DE5;&#x4F5C;&#x3002;<br>&#x6CE8;&#x89E3;&#x5904;&#x7406;&#x5668;&#x4EE5;&#x53CA;&#x7A0B;&#x5E8F;&#x6846;&#x67B6;api&#x53EF;&#x4EE5;&#x5728; <code>build-time</code> &#x65F6;&#x8BBF;&#x95EE;&#xFF1B;&#x4E3E;&#x4E2A;&#x4F8B;&#x5B50;&#xFF0C;&#x6B64;&#x529F;&#x80FD;&#x63D0;&#x4F9B;&#x4E86;&#x6838;&#x5FC3;&#x53CD;&#x5C04;&#x652F;&#x6301;&#x7528;&#x4E8E;&#x8BFB;&#x53D6;&#x6CE8;&#x89E3;&#xFF08;&#x6CE8;&#xFF1A;&#x4E00;&#x822C;&#x6307;&#x4ECE;&#x6E90;&#x7801;&#x5185;&#x8BFB;&#x53D6;&#x6CE8;&#x89E3;&#x6216;&#x8005;&#x53EA;&#x8BFB;&#x53D6;&#x6807;&#x6CE8;&#x4E3A;<code>source-only</code>&#x7684;&#x6CE8;&#x89E3;&#xFF09;&#x3002;</p></blockquote><p>&#x5373;&#xFF0C;&#x5728;J2SE 1.6&#x7248;&#x672C;&#x52A0;&#x5165;&#x7684;JSR269&#x7684;&#x4E3B;&#x8981;&#x70B9;&#x5982;&#x4E0B;&#xFF1A;</p><ul><li>&#x4E13;&#x95E8;&#x7528;&#x4E8E;&#x652F;&#x6301; J2SE 1.5 &#x65E0;&#x6CD5;&#x5904;&#x7406;&#x7684; <code>build-time</code> &#x6CE8;&#x89E3;&#x5904;&#x7406;&#x573A;&#x666F;&#xFF0C;&#x5E76;&#x5B9A;&#x4E49;&#x901A;&#x7528;&#x6CE8;&#x89E3;&#x5904;&#x7406;API</li><li>&#x5F15;&#x5165;&#x7A0B;&#x5E8F;&#x6846;&#x67B6;api</li></ul><h3 id="JSR269&#x8FD0;&#x884C;&#x673A;&#x5236;"><a href="#JSR269&#x8FD0;&#x884C;&#x673A;&#x5236;" class="headerlink" title="JSR269&#x8FD0;&#x884C;&#x673A;&#x5236;"></a>JSR269&#x8FD0;&#x884C;&#x673A;&#x5236;</h3><pre class="mermaid">sequenceDiagram;
  javac/Main-&gt;&gt;javac/Main: new main.Main(&quot;javac)
  javac/Main-&gt;&gt;main/Main: &#x7F16;&#x8BD1;&#x53C2;&#x6570;&#x4F20;&#x9012;
  main/Main-&gt;&gt;main/Main: Javac&#x4E0A;&#x4E0B;&#x6587;&#x521B;&#x5EFA;
  main/Main-&gt;&gt;main/Main: JavaFileManager.preRegister&#x9884;&#x6CE8;&#x518C;
  main/Main-&gt;&gt;main/Main: &#x6267;&#x884C;compile&#x5E76;&#x4F20;&#x9012;&#x7F16;&#x8BD1;&#x53C2;&#x6570;&#x4EE5;&#x53CA;&#x4E0A;&#x4E0B;&#x6587;
  main/Main--&gt;&gt;javac/Main: &#x53C2;&#x6570;&#x6709;&#x8BEF;&#x663E;&#x793A;&#x5E2E;&#x52A9;&#x4FE1;&#x606F;
  main/Main-&gt;&gt;main/Main: &#x53C2;&#x6570;&#x89E3;&#x6790;(&#x83B7;&#x53D6;class&#x4EE5;&#x53CA;files&#x5E76;&#x521D;&#x59CB;&#x5316;&#x6CE8;&#x89E3;&#x5904;&#x7406;&#x5668;&#x8DEF;&#x5F84;)
  alt &#x89E3;&#x6790;&#x7684;&#x6587;&#x4EF6;&#x4E3A;&#x7A7A;&#x4E14;&#x542B;&#x6709;&#x6CE8;&#x89E3;&#x5904;&#x7406;&#x53C2;&#x6570;
    main/Main--&gt;&gt;javac/Main: &#x65E0;source.files.classes
  else &#x5B58;&#x5728;&#x6587;&#x4EF6;&#x6216;&#x8005;&#x65E0;&#x6CE8;&#x89E3;&#x5904;&#x7406;&#x53C2;&#x6570;
    main/Main-&gt;&gt;main/Main: JavaCompiler&#x5B9E;&#x4F8B;&#x521B;&#x5EFA;
    main/Main-&gt;&gt;main/JavaCompiler: &#x4F20;&#x9012;&#x6E90;&#x6587;&#x4EF6;&#x5217;&#x8868;&#x4EE5;&#x53CA;&#x7C7B;&#x5217;&#x8868;
    alt PROC&#x4E3A;none&#x503C;
      main/JavaCompiler-&gt;&gt;main/JavaCompiler: &#x4E0D;&#x521D;&#x59CB;&#x5316;
    else PROC&#x975E;none&#x503C;
      main/JavaCompiler-&gt;&gt;main/JavaCompiler: &#x521D;&#x59CB;&#x5316;&#x6CE8;&#x89E3;
      main/JavaCompiler-&gt;&gt;processing/JavaProcessingEnvironment: &#x8BBE;&#x7F6E;Processors
      processing/JavaProcessingEnvironment-&gt;&gt;processing/JavaProcessingEnvironment: &#x4ECE;&#x53C2;&#x6570;&#x83B7;&#x53D6;processors
      processing/JavaProcessingEnvironment-&gt;&gt;processing/JavaProcessingEnvironment: processors&#x521D;&#x59CB;&#x5316;&#x5E76;&#x8D4B;&#x503C;&#x7ED9;discoveredProcs
    end
    main/JavaCompiler-&gt;&gt;main/JavaCompiler: &#x5904;&#x7406;&#x6CE8;&#x89E3;
    main/JavaCompiler-&gt;&gt;main/JavaCompiler: &#x5C06;&#x9700;&#x8981;&#x7684;package&#x6CE8;&#x89E3;&#x4EE5;&#x53CA;class&#x6CE8;&#x89E3;&#x52A0;&#x5165;&#x5F85;&#x5904;&#x7406;&#x5217;&#x8868;
    main/JavaCompiler-&gt;&gt;processing/JavaProcessingEnvironment: &#x4F20;&#x9012;&#x4E0A;&#x4E0B;&#x6587;&#x3001;&#x5F85;&#x5904;&#x7406;&#x7684;&#x5305;&#x7C7B;&#x6CE8;&#x89E3;&#x5217;&#x8868;
    processing/JavaProcessingEnvironment-&gt;&gt;processing/JavaProcessingEnvironment: &#x6784;&#x9020;Round
    loop &#x5FAA;&#x73AF;&#x76F4;&#x5230;&#x6CA1;&#x6709;&#x65B0;&#x6587;&#x4EF6;&#x4EA7;&#x751F;(moreToDo&#x65B9;&#x6CD5;)
      processing/JavaProcessingEnvironment-&gt;&gt;processing/Round: &#x6784;&#x9020;JavacRoundEnvironment&#xFF0C;&#x4F20;&#x9012;&#x5305;&#x7C7B;
      processing/Round-&gt;&gt;processing/Round: &#x901A;&#x8FC7;&#x9876;&#x5C42;&#x7684;&#x5305;&#x7C7B;&#x627E;&#x5230;&#x6240;&#x6709;&#x652F;&#x6301;&#x7684;&#x6CE8;&#x89E3;
      loop &#x5FAA;&#x73AF;discoveredProcs
        processing/Round-&gt;&gt;processing/Round: &#x901A;&#x8FC7;&#x53D8;&#x91CF;annotationsPresent&#x5224;&#x65AD;&#x8FD9;&#x4E2A;&#x6CE8;&#x89E3;&#x662F;&#x5426;&#x652F;&#x6301;
        alt &#x6CE8;&#x89E3;&#x652F;&#x6301;
          processing/Round-&gt;&gt;processing/Round: &#x52A0;&#x5165;&#x5F85;&#x5904;&#x7406;&#x5217;&#x8868;&#xFF1B;matchedNames&#x6DFB;&#x52A0;&#x652F;&#x6301;&#x7684;&#x6CE8;&#x89E3;&#x540D;
        else &#x6CE8;&#x89E3;&#x4E0D;&#x652F;&#x6301;
          processing/Round-&gt;&gt;processing/Round: &#x4E0D;&#x505A;&#x5904;&#x7406;&#xFF0C;&#x7EE7;&#x7EED;&#x4E0B;&#x4E00;&#x6B65;
        end
        alt matchedNames&#x662F;&#x5426;&#x4E0D;&#x4E3A;&#x7A7A;&#x4E14;&#x5904;&#x7406;&#x5668;&#x662F;&#x5426;&#x5DF2;&#x88AB;&#x6267;&#x884C;
          processing/Round-&gt;&gt;processing/Round: &#x8C03;&#x7528;&#x6CE8;&#x89E3;&#x5904;&#x7406;&#x5668;&#x7684;process&#x65B9;&#x6CD5;
          processing/Round-&gt;&gt;processing/Round: &#x6807;&#x8BB0;&#x6CE8;&#x89E3;&#x5904;&#x7406;&#x5668;&#x5DF2;&#x88AB;&#x6267;&#x884C;
          alt &#x6267;&#x884C;&#x7ED3;&#x679C;&#x662F;&#x4E3A;true
            processing/Round-&gt;&gt;processing/Round: unmatchedAnnotations&#x79FB;&#x9664;matchedNames&#x5185;&#x6240;&#x6709;&#x5339;&#x914D;&#x7684;&#x9879;
          else &#x6267;&#x884C;&#x7ED3;&#x679C;&#x4E3A;false
            processing/Round-&gt;&gt;processing/Round: &#x4E0D;&#x505A;&#x5904;&#x7406;&#xFF0C;&#x7EE7;&#x7EED;&#x4E0B;&#x4E00;&#x6B65;
          end
        else 
          processing/Round-&gt;&gt;processing/Round: &#x4E0D;&#x505A;&#x5904;&#x7406;&#xFF0C;&#x7EE7;&#x7EED;&#x4E0B;&#x4E00;&#x6B65;
        end
      end
      processing/Round--&gt;&gt;processing/JavaProcessingEnvironment: &#x4E00;&#x6B21;round&#x5FAA;&#x73AF;&#x5B8C;&#x6210;
      processing/JavaProcessingEnvironment-&gt;&gt;processing/JavaProcessingEnvironment: &#x6784;&#x5EFA;&#x4E0B;&#x4E00;&#x4E2A;round
    end
    processing/JavaProcessingEnvironment-&gt;&gt;processing/Round: &#x6267;&#x884C;&#x6700;&#x540E;&#x4E00;&#x6B21;run&#x65B9;&#x6CD5;
    processing/Round-&gt;&gt;processing/DiscoveredProcessors: &#x6240;&#x6709;&#x6267;&#x884C;&#x8FC7;&#x7684;processor&#x4F1A;&#x5E26;&#x4E0A;&#x7A7A;&#x6CE8;&#x89E3;&#x96C6;&#x5408;&#x53C2;&#x6570;&#x518D;&#x6B21;&#x6267;&#x884C;&#x4E00;&#x904D;
    processing/DiscoveredProcessors--&gt;&gt;processing/Round: &#x5B8C;&#x6210;&#x6267;&#x884C;
    processing/Round--&gt;&gt;processing/JavaProcessingEnvironment: &#x5B8C;&#x6210;&#x6700;&#x540E;&#x4E00;&#x6B21;round
    processing/JavaProcessingEnvironment-&gt;&gt;processing/JavaProcessingEnvironment: &#x5224;&#x65AD;&#x672C;&#x6B21;&#x662F;&#x5426;&#x5B58;&#x5728;&#x9519;&#x8BEF;&#xFF0C;&#x5B58;&#x5728;&#x5219;&#x6807;&#x8BB0;errorStatus
    processing/JavaProcessingEnvironment-&gt;&gt;processing/JavaProcessingEnvironment: &#x6E05;&#x7406;&#x6240;&#x6709;&#x5305;&#x7C7B;
    processing/JavaProcessingEnvironment-&gt;&gt;processing/JavaProcessingEnvironment: &#x6784;&#x5EFA;&#x4E3A;&#x6700;&#x7EC8;&#x7F16;&#x8BD1;&#x4F7F;&#x7528;&#x7684;JavaCompiler
    alt errorStatus&#x72B6;&#x6001;&#x4E3A;true
      processing/JavaProcessingEnvironment-&gt;&gt;processing/JavaProcessingEnvironment: &#x9519;&#x8BEF;&#x6570;&#x4E0D;&#x4E3A;0&#x8FD4;&#x56DE;&#x7F16;&#x8BD1;&#x5668;
      processing/JavaProcessingEnvironment-&gt;&gt;processing/JavaProcessingEnvironment: &#x9519;&#x8BEF;&#x6570;&#x4E3A;0&#x65E5;&#x5FD7;&#x8BB0;&#x5F55;&#x65E0;&#x9519;&#x8BEF;+1
    else erroStatus&#x72B6;&#x6001;&#x4E3A;false
      processing/JavaProcessingEnvironment-&gt;&gt;processing/JavaProcessingEnvironment: enterTrees
    end
    processing/JavaProcessingEnvironment--&gt;&gt;main/JavaCompiler: &#x8FD4;&#x56DE;&#x7F16;&#x8BD1;&#x5668;
    main/JavaCompiler--&gt;&gt;main/Main: &#x6267;&#x884C;&#x7F16;&#x8BD1;&#x5B8C;&#x6210;
    alt &#x9519;&#x8BEF;&#x6570;&#x5927;&#x4E8E;0
      main/Main--&gt;&gt;javac/Main: &#x6267;&#x884C;&#x9519;&#x8BEF;
    else &#x4E3A;&#x7A7A;
      main/Main--&gt;&gt;javac/Main: &#x6267;&#x884C;&#x6B63;&#x786E;
    end
  end</pre><h3 id="&#x6837;&#x4F8B;"><a href="#&#x6837;&#x4F8B;" class="headerlink" title="&#x6837;&#x4F8B;"></a>&#x6837;&#x4F8B;</h3><p>&#x6784;&#x5EFA;&#x4E09;&#x4E2A;&#x6A21;&#x5757;&#xFF1A;</p><ol><li>&#x6CE8;&#x89E3;&#x5904;&#x7406;&#x7C7B;&#x4EE5;&#x53CA;&#x76EE;&#x6807;&#x6CE8;&#x89E3;&#x7C7B;</li><li>&#x6CE8;&#x89E3;&#x6CE8;&#x518C;&#x4E3A;&#x670D;&#x52A1;</li><li>&#x8C03;&#x7528;&#x65B9;</li></ol><h4 id="&#x6CE8;&#x89E3;&#x7C7B;&#x4EE5;&#x53CA;&#x5904;&#x7406;&#x7C7B;"><a href="#&#x6CE8;&#x89E3;&#x7C7B;&#x4EE5;&#x53CA;&#x5904;&#x7406;&#x7C7B;" class="headerlink" title="&#x6CE8;&#x89E3;&#x7C7B;&#x4EE5;&#x53CA;&#x5904;&#x7406;&#x7C7B;"></a>&#x6CE8;&#x89E3;&#x7C7B;&#x4EE5;&#x53CA;&#x5904;&#x7406;&#x7C7B;</h4><p>&#x6CE8;&#x89E3;&#x7C7B;&#xFF1A;<br></p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Target</span>({ElementType.METHOD, ElementType.TYPE})</span><br><span class="line"><span class="meta">@Retention</span>(RetentionPolicy.SOURCE)</span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> Test {</span><br><span class="line"></span><br><span class="line">    <span class="function">String <span class="title">value</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p></p><p>&#x6CE8;&#x89E3;&#x5904;&#x7406;&#x7C7B;&#xFF1A;<br></p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SupportedAnnotationTypes</span>(value = {<span class="string">&quot;com.whatakitty.learn.jsr269.Test&quot;</span>})</span><br><span class="line"><span class="meta">@SupportedSourceVersion</span>(value = SourceVersion.RELEASE_8)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AnnotationProcessor</span> <span class="keyword">extends</span> <span class="title">AbstractProcessor</span> </span>{</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Messager messager;</span><br><span class="line">    <span class="keyword">private</span> AtomicInteger atomicInteger;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">(ProcessingEnvironment env)</span> </span>{</span><br><span class="line">        messager = env.getMessager();</span><br><span class="line">        atomicInteger = <span class="keyword">new</span> AtomicInteger(<span class="number">0</span>);</span><br><span class="line">        <span class="keyword">super</span>.init(env);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">process</span><span class="params">(Set&lt;? extends TypeElement&gt; annotations, RoundEnvironment roundEnv)</span> </span>{</span><br><span class="line">        messager.printMessage(Diagnostic.Kind.NOTE, <span class="string">&quot;Hello World!&quot;</span> + atomicInteger.incrementAndGet());</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p></p><h4 id="&#x6CE8;&#x518C;&#x670D;&#x52A1;"><a href="#&#x6CE8;&#x518C;&#x670D;&#x52A1;" class="headerlink" title="&#x6CE8;&#x518C;&#x670D;&#x52A1;"></a>&#x6CE8;&#x518C;&#x670D;&#x52A1;</h4><p>&#x5728;&#x6587;&#x4EF6;&#x5939;<code>resources/META-INF/services</code>&#x4E0B;&#x521B;&#x5EFA;&#x6587;&#x4EF6;<code>javax.annotation.processing.Processor</code>&#xFF0C;&#x5185;&#x5BB9;&#x5982;&#x4E0B;&#xFF1A;<br></p><figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">com.whatakitty.learn.jsr269.AnnotationProcessor</span><br></pre></td></tr></tbody></table></figure><p></p><h4 id="&#x8C03;&#x7528;&#x65B9;"><a href="#&#x8C03;&#x7528;&#x65B9;" class="headerlink" title="&#x8C03;&#x7528;&#x65B9;"></a>&#x8C03;&#x7528;&#x65B9;</h4><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Test1</span> </span>{</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>{</span><br><span class="line">        System.out.println(<span class="string">&quot;success&quot;</span>);</span><br><span class="line">        test();</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span>(<span class="string">&quot;method is test&quot;</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">test</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>{</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><h4 id="&#x8FD0;&#x884C;&#x7ED3;&#x679C;"><a href="#&#x8FD0;&#x884C;&#x7ED3;&#x679C;" class="headerlink" title="&#x8FD0;&#x884C;&#x7ED3;&#x679C;"></a>&#x8FD0;&#x884C;&#x7ED3;&#x679C;</h4><p><img src="https://static.xuqiang.me/public/images/191455.jpg" alt="javac-annotation-pluggable-api&#x8FD0;&#x884C;&#x7ED3;&#x679C;"></p><p>&#x53EF;&#x4EE5;&#x770B;&#x5230;&#xFF0C;&#x4E0A;&#x56FE;&#x4E2D;&#x5DF2;&#x7ECF;&#x8F93;&#x51FA;&#x4E24;&#x6B21;<strong>Hello World!</strong>&#x3002;&#x81F3;&#x4E8E;&#x4E3A;&#x4EC0;&#x4E48;&#x4F1A;&#x8F93;&#x51FA;&#x4E24;&#x6B21;&#xFF0C;&#x662F;&#x7531;&#x4E8E;&#x7B2C;&#x4E00;&#x6B21;&#x662F;&#x672C;&#x8EAB;&#x6CE8;&#x89E3;&#x7684;&#x5904;&#x7406;&#x8C03;&#x7528;&#xFF1B;&#x6700;&#x540E;&#x4E00;&#x6B21;&#x662F;&#xFF0C;jdk&#x4F1A;&#x5728;&#x6240;&#x6709;&#x6CE8;&#x89E3;&#x5904;&#x7406;&#x5B8C;&#x6210;&#x540E;&#xFF0C;&#x5C06;&#x6240;&#x6709;&#x5904;&#x7406;&#x8FC7;&#x7684;&#x6CE8;&#x89E3;&#x5168;&#x90E8;&#x4F20;&#x5165;&#x7A7A;&#x6CE8;&#x89E3;&#x518D;&#x6B21;&#x6267;&#x884C;&#x4E00;&#x904D;&#xFF0C;&#x4EE3;&#x7801;&#x5982;&#x4E0B;&#xFF1A;<br></p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">  * Run all remaining processors on the procStateList that</span></span><br><span class="line"><span class="comment">  * have not already run this round with an empty set of</span></span><br><span class="line"><span class="comment">  * annotations.</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">runContributingProcs</span><span class="params">(RoundEnvironment re)</span> </span>{</span><br><span class="line">  <span class="keyword">if</span> (!onProcInterator) {</span><br><span class="line">    <span class="comment">// &#x6784;&#x9020;&#x7A7A;&#x7684;&#x6CE8;&#x89E3;&#x5143;&#x7D20;&#x96C6;&#x5408;</span></span><br><span class="line">    Set&lt;TypeElement&gt; emptyTypeElements = Collections.emptySet();</span><br><span class="line">    <span class="comment">// &#x904D;&#x5386;&#x6240;&#x6709;&#x6CE8;&#x518C;&#x7684;&#x6CE8;&#x89E3;&#x5904;&#x7406;&#x5668;</span></span><br><span class="line">    <span class="keyword">while</span>(innerIter.hasNext()) {</span><br><span class="line">        ProcessorState ps = innerIter.next();</span><br><span class="line">        <span class="comment">// &#x5224;&#x65AD;&#x8BE5;&#x6CE8;&#x89E3;&#x5904;&#x7406;&#x5668;&#x662F;&#x5426;&#x5728;&#x4E4B;&#x524D;&#x5904;&#x7406;&#x8FC7;&#x6CE8;&#x89E3;&#xFF0C;&#x672A;&#x53C2;&#x4E0E;&#x8FC7;&#x7684;&#x4E0D;&#x4F1A;&#x8C03;&#x7528;</span></span><br><span class="line">        <span class="keyword">if</span> (ps.contributed)</span><br><span class="line">          <span class="comment">// &#x4F20;&#x5165;&#x7A7A;&#x7684;&#x6CE8;&#x89E3;&#x5143;&#x7D20;&#x96C6;&#x5408;&#xFF0C;&#x91CD;&#x65B0;&#x8C03;&#x7528;&#x4E00;&#x6B21;&#x6CE8;&#x89E3;&#x5904;&#x7406;&#x5668;</span></span><br><span class="line">          callProcessor(ps.processor, emptyTypeElements, re);</span><br><span class="line">    }</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p></p><h3 id="Lombok&#x539F;&#x7406;"><a href="#Lombok&#x539F;&#x7406;" class="headerlink" title="Lombok&#x539F;&#x7406;"></a>Lombok&#x539F;&#x7406;</h3><p>Lombok&#x57FA;&#x4E8E;JSR269 API&#x5B9E;&#x73B0;&#x4E86;&#x901A;&#x8FC7;&#x7279;&#x5B9A;&#x6CE8;&#x89E3;&#x751F;&#x6210;&#x5BF9;&#x5E94;&#x4EE3;&#x7801;&#x7684;&#x529F;&#x80FD;&#x3002;</p><p>Lombok&#x4E3B;&#x8981;&#x5728;&#x7C7B;<code>LombokProcessor</code>&#x5904;&#x7406;&#x4E86;&#x81EA;&#x5DF1;&#x7684;&#x6CE8;&#x89E3;&#x901A;&#x8FC7;AST&#x751F;&#x6210;&#x4EE3;&#x7801;&#x3002;&#x5982;&#x4E0B;&#xFF0C;&#x4E3B;&#x8981;&#x770B;&#x4E24;&#x4E2A;&#x91CD;&#x5199;&#x65B9;&#x6CD5;&#xFF1A;<br></p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// &#x521D;&#x59CB;&#x5316;&#x672C;&#x6B21;&#x5904;&#x7406;&#x7684;&#x4E00;&#x4E9B;&#x53D8;&#x91CF;&#x7B49;</span></span><br><span class="line"><span class="meta">@Override</span> <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">(ProcessingEnvironment procEnv)</span> </span>{</span><br><span class="line">  <span class="keyword">super</span>.init(procEnv);</span><br><span class="line">  <span class="comment">// &#x5224;&#x65AD;lombok&#x662F;&#x5426;&#x88AB;&#x7981;&#x7528;</span></span><br><span class="line">  <span class="keyword">if</span> (System.getProperty(<span class="string">&quot;lombok.disable&quot;</span>) != <span class="keyword">null</span>) {</span><br><span class="line">    lombokDisabled = <span class="keyword">true</span>;</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  }</span><br><span class="line"></span><br><span class="line">  <span class="keyword">this</span>.processingEnv = procEnv;</span><br><span class="line">  <span class="keyword">this</span>.javacProcessingEnv = getJavacProcessingEnvironment(procEnv);</span><br><span class="line">  <span class="keyword">this</span>.javacFiler = getJavacFiler(procEnv.getFiler());</span><br><span class="line"></span><br><span class="line">  <span class="comment">// &#x66FF;&#x6362;&#x7C7B;&#x52A0;&#x8F7D;&#x5668;&#x3001;&#x5BF9;netbeans IDE&#x76F8;&#x5173;hook&#x5904;&#x7406;&#x3001;&#x66FF;&#x6362;JavaFileManager</span></span><br><span class="line">  placePostCompileAndDontMakeForceRoundDummiesHook();</span><br><span class="line">  trees = Trees.instance(javacProcessingEnv);</span><br><span class="line">  transformer = <span class="keyword">new</span> JavacTransformer(procEnv.getMessager(), trees);</span><br><span class="line">  <span class="comment">// &#x83B7;&#x53D6;&#x6807;&#x8BB0;HandlerPriority&#x6CE8;&#x89E3;&#x7684;&#x6240;&#x6709;&#x4F18;&#x5148;&#x7EA7;</span></span><br><span class="line">  SortedSet&lt;Long&gt; p = transformer.getPriorities();</span><br><span class="line">  <span class="keyword">if</span> (p.isEmpty()) {</span><br><span class="line">    <span class="keyword">this</span>.priorityLevels = <span class="keyword">new</span> <span class="keyword">long</span>[] {<span class="number">0L</span>};</span><br><span class="line">    <span class="keyword">this</span>.priorityLevelsRequiringResolutionReset = <span class="keyword">new</span> HashSet&lt;Long&gt;();</span><br><span class="line">  } <span class="keyword">else</span> {</span><br><span class="line">    <span class="keyword">this</span>.priorityLevels = <span class="keyword">new</span> <span class="keyword">long</span>[p.size()];</span><br><span class="line">    <span class="keyword">int</span> i = <span class="number">0</span>;</span><br><span class="line">    <span class="comment">// &#x5FAA;&#x73AF;&#x6240;&#x6709;&#x83B7;&#x53D6;&#x5230;&#x7684;&#x6CE8;&#x91CA;&#x6216;&#x8005;visit&#x5904;&#x7406;&#x4F18;&#x5148;&#x7EA7;</span></span><br><span class="line">    <span class="keyword">for</span> (Long prio : p) <span class="keyword">this</span>.priorityLevels[i++] = prio;</span><br><span class="line">    <span class="keyword">this</span>.priorityLevelsRequiringResolutionReset = transformer.getPrioritiesRequiringResolutionReset();</span><br><span class="line">  }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">/** {<span class="doctag">@inheritDoc</span>} */</span></span><br><span class="line"><span class="meta">@Override</span> <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">process</span><span class="params">(Set&lt;? extends TypeElement&gt; annotations, RoundEnvironment roundEnv)</span> </span>{</span><br><span class="line">  <span class="comment">// &#x5982;&#x679C;&#x7981;&#x7528;&#xFF0C;&#x5219;&#x4E0D;&#x5904;&#x7406;lombok&#x6CE8;&#x89E3;</span></span><br><span class="line">  <span class="keyword">if</span> (lombokDisabled) <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">  <span class="comment">// &#x662F;&#x5426;&#x5DF2;&#x7ECF;&#x5904;&#x7406;&#x7ED3;&#x675F;</span></span><br><span class="line">  <span class="keyword">if</span> (roundEnv.processingOver()) {</span><br><span class="line">    cleanup.run();</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">  }</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// We have: A sorted set of all priority levels: &apos;priorityLevels&apos;</span></span><br><span class="line">  </span><br><span class="line">  <span class="comment">// Step 1: Take all CUs which aren&apos;t already in the map. Give them the first priority level.</span></span><br><span class="line">  </span><br><span class="line">  String randomModuleName = <span class="keyword">null</span>;</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// &#x6807;&#x8BB0;&#x6240;&#x6709;&#x7F16;&#x8BD1;&#x5355;&#x5143;&#x7684;&#x4F18;&#x5148;&#x7EA7;</span></span><br><span class="line">  <span class="comment">// &#x5982;&#x679C;&#x662F;&#x7B2C;&#x4E8C;&#x6B21;&#x5FAA;&#x73AF;&#xFF0C;&#x56E0;&#x4E3A;roots&#x5DF2;&#x7ECF;&#x5305;&#x542B;&#x4E86;&#x8FD9;&#x4E2A;&#x7F16;&#x8BD1;&#x5355;&#x5143;&#xFF0C;&#x6240;&#x4EE5;&#x4F1A;&#x5FFD;&#x7565;</span></span><br><span class="line">  <span class="keyword">for</span> (Element element : roundEnv.getRootElements()) {</span><br><span class="line">    <span class="keyword">if</span> (randomModuleName == <span class="keyword">null</span>) randomModuleName = getModuleNameFor(element);</span><br><span class="line">    JCCompilationUnit unit = toUnit(element);</span><br><span class="line">    <span class="keyword">if</span> (unit == <span class="keyword">null</span>) <span class="keyword">continue</span>;</span><br><span class="line">    <span class="keyword">if</span> (roots.containsKey(unit)) <span class="keyword">continue</span>;</span><br><span class="line">    roots.put(unit, priorityLevels[<span class="number">0</span>]);</span><br><span class="line">  }</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">while</span> (<span class="keyword">true</span>) {</span><br><span class="line">    <span class="comment">// Step 2: For all CUs (in the map, not the roundEnv!), run them across all handlers at their current prio level.</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// &#x5FAA;&#x73AF;&#x4F18;&#x5148;&#x7EA7;&#x5217;&#x8868;</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">long</span> prio : priorityLevels) {</span><br><span class="line">      List&lt;JCCompilationUnit&gt; cusForThisRound = <span class="keyword">new</span> ArrayList&lt;JCCompilationUnit&gt;();</span><br><span class="line">      <span class="comment">// &#x83B7;&#x53D6;&#x5728;&#x8BE5;&#x4F18;&#x5148;&#x7EA7;&#x4E0B;&#x7684;&#x6240;&#x6709;&#x7F16;&#x8BD1;&#x5355;&#x5143;&#x5E76;&#x52A0;&#x5165;&#x8BE5;&#x4F18;&#x5148;&#x7EA7;&#x4E0B;&#x9700;&#x8981;&#x5904;&#x7406;&#x7684;&#x7F16;&#x8BD1;&#x5355;&#x5143;&#x5217;&#x8868;&#x5185;</span></span><br><span class="line">      <span class="keyword">for</span> (Map.Entry&lt;JCCompilationUnit, Long&gt; entry : roots.entrySet()) {</span><br><span class="line">        Long prioOfCu = entry.getValue();</span><br><span class="line">        <span class="keyword">if</span> (prioOfCu == <span class="keyword">null</span> || prioOfCu != prio) <span class="keyword">continue</span>;</span><br><span class="line">        cusForThisRound.add(entry.getKey());</span><br><span class="line">      }</span><br><span class="line">      <span class="comment">// &#x6309;&#x7167;&#x4F18;&#x5148;&#x7EA7;&#x987A;&#x5E8F;&#x6267;&#x884C;&#x7F16;&#x8BD1;&#x5355;&#x5143;</span></span><br><span class="line">      <span class="comment">// &#x8BBF;&#x95EE;AST&#x6811;&#x5E76;&#x7F16;&#x8BD1;&#x76EE;&#x6807;&#x6CE8;&#x89E3;</span></span><br><span class="line">      transformer.transform(prio, javacProcessingEnv.getContext(), cusForThisRound, cleanup);</span><br><span class="line">    }</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// Step 3: Push up all CUs to the next level. Set level to null if there is no next level.</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// &#x6392;&#x9664;&#x6389;&#x5217;&#x8868;&#x7B2C;&#x4E00;&#x4E2A;&#x4F18;&#x5148;&#x7EA7;&#x51C6;&#x5907;&#x6267;&#x884C;&#x4E0B;&#x4E00;&#x6B21;&#x5FAA;&#x73AF;</span></span><br><span class="line">    Set&lt;Long&gt; newLevels = <span class="keyword">new</span> HashSet&lt;Long&gt;();</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = priorityLevels.length - <span class="number">1</span>; i &gt;= <span class="number">0</span>; i--) {</span><br><span class="line">      Long curLevel = priorityLevels[i];</span><br><span class="line">      Long nextLevel = (i == priorityLevels.length - <span class="number">1</span>) ? <span class="keyword">null</span> : priorityLevels[i + <span class="number">1</span>];</span><br><span class="line">      List&lt;JCCompilationUnit&gt; cusToAdvance = <span class="keyword">new</span> ArrayList&lt;JCCompilationUnit&gt;();</span><br><span class="line">      <span class="keyword">for</span> (Map.Entry&lt;JCCompilationUnit, Long&gt; entry : roots.entrySet()) {</span><br><span class="line">        <span class="keyword">if</span> (curLevel.equals(entry.getValue())) {</span><br><span class="line">          cusToAdvance.add(entry.getKey());</span><br><span class="line">          newLevels.add(nextLevel);</span><br><span class="line">        }</span><br><span class="line">      }</span><br><span class="line">      <span class="keyword">for</span> (JCCompilationUnit unit : cusToAdvance) {</span><br><span class="line">        roots.put(unit, nextLevel);</span><br><span class="line">      }</span><br><span class="line">    }</span><br><span class="line">    newLevels.remove(<span class="keyword">null</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// Step 4: If ALL values are null, quit. Else, either do another loop right now or force a resolution reset by forcing a new round in the annotation processor.</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// &#x5224;&#x65AD;&#x662F;&#x5426;&#x5C06;&#x6240;&#x6709;&#x4F18;&#x5148;&#x7EA7;&#x6392;&#x9664;&#xFF0C;&#x4F18;&#x5148;&#x7EA7;&#x5217;&#x8868;&#x4E3A;&#x7A7A;&#xFF0C;&#x5219;&#x7ED3;&#x675F;</span></span><br><span class="line">    <span class="keyword">if</span> (newLevels.isEmpty()) <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    newLevels.retainAll(priorityLevelsRequiringResolutionReset);</span><br><span class="line">    <span class="keyword">if</span> (!newLevels.isEmpty()) {</span><br><span class="line">      <span class="comment">// Force a new round to reset resolution. The next round will cause this method (process) to be called again.</span></span><br><span class="line">      forceNewRound(randomModuleName, javacFiler);</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    }</span><br><span class="line">    <span class="comment">// None of the new levels need resolution, so just keep going.</span></span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p></p><p><code>init</code>&#x65B9;&#x6CD5;&#x4E3B;&#x8981;&#x662F;&#x505A;&#x4E00;&#x4E9B;&#x521D;&#x59CB;&#x5316;&#xFF1B;</p><p><code>process</code>&#x65B9;&#x6CD5;&#x5185;&#x4E3B;&#x8981;&#x662F;&#x5C06;&#x6CE8;&#x89E3;&#x4EE5;&#x53CA;visitor&#x5904;&#x7406;&#x5668;&#x7684;&#x6309;&#x7167;&#x4F18;&#x5148;&#x7EA7;&#x5212;&#x5206;&#xFF0C;&#x7136;&#x540E;&#x6BCF;&#x6B21;&#x6267;&#x884C;&#x5B8C;&#x6210;&#x540E;&#xFF0C;&#x6392;&#x9664;&#x6700;&#x5F00;&#x59CB;&#x7684;&#x4E00;&#x4E2A;&#x4F18;&#x5148;&#x7EA7;&#x540E;&#xFF0C;&#x91CD;&#x65B0;&#x5F00;&#x59CB;&#x4E0B;&#x4E00;&#x8F6E;&#x7F16;&#x8BD1;&#x3002;&#x77E5;&#x9053;&#x6240;&#x6709;&#x4F18;&#x5148;&#x7EA7;&#x6392;&#x9664;&#x5B8C;&#x6BD5;&#x3002;&#x8FD9;&#x4E48;&#x505A;&#x7684;&#x539F;&#x56E0;&#xFF0C;&#x5E94;&#x8BE5;&#x662F;&#x4E3A;&#x4E86;&#x5728;&#x9AD8;&#x4F18;&#x5148;&#x7EA7;&#x5904;&#x7406;&#x5668;&#x5904;&#x7406;&#x5B8C;&#x6210;&#x751F;&#x6210;&#x6587;&#x4EF6;&#x540E;&#xFF0C;&#x80FD;&#x591F;&#x8BA9;&#x4F4E;&#x4F18;&#x5148;&#x7EA7;&#x5904;&#x7406;&#x5668;&#x6839;&#x636E;&#x9AD8;&#x4F18;&#x5148;&#x7EA7;&#x5904;&#x7406;&#x5668;&#x751F;&#x6210;&#x7684;&#x6587;&#x4EF6;&#x91CD;&#x65B0;&#x6267;&#x884C;&#x4E00;&#x904D;&#x9632;&#x6B62;&#x9057;&#x6F0F;&#x751F;&#x6210;&#x7684;&#x65B0;&#x7684;&#x4EE3;&#x7801;</p><h3 id="&#x603B;&#x7ED3;"><a href="#&#x603B;&#x7ED3;" class="headerlink" title="&#x603B;&#x7ED3;"></a>&#x603B;&#x7ED3;</h3><ul><li>&#x8BE6;&#x7EC6;&#x4E86;&#x89E3;&#x4E86;JSR269&#x5185;&#x90E8;&#x7684;&#x6267;&#x884C;&#x903B;&#x8F91;</li><li>&#x4E86;&#x89E3;&#x4E86;JAVAC&#x7684;&#x7F16;&#x8BD1;&#x8FC7;&#x7A0B;</li><li>&#x4E86;&#x89E3;&#x4E86;Lombok&#x5185;&#x90E8;&#x7684;&#x6267;&#x884C;&#x539F;&#x7406;&#xFF0C;&#x53EF;&#x4EE5;&#x4F9D;&#x6258;&#x73B0;&#x6709;Lombok&#x5904;&#x7406;&#x5668;&#xFF0C;&#x81EA;&#x5B9A;&#x4E49;&#x6CE8;&#x89E3;</li></ul><p>&#x603B;&#x4E4B;&#xFF0C;&#x6536;&#x83B7;&#x6EE1;&#x6EE1;&#x3002;</p><script>document.querySelectorAll('.github-emoji')
          .forEach(el => {
            if (!el.dataset.src) { return; }
            const img = document.createElement('img');
            img.style = 'display:none !important;';
            img.src = el.dataset.src;
            img.addEventListener('error', () => {
              img.remove();
              el.style.color = 'inherit';
              el.style.backgroundImage = 'none';
              el.style.background = 'none';
            });
            img.addEventListener('load', () => {
              img.remove();
            });
            document.body.appendChild(img);
          });</script></div></div><div class="article-copyright"><div class="copyright"><p><span>本文标题:</span><a href="/JSR269插件化注解API.html">JSR269插件化注解API</a></p><p><span>文章作者:</span><a href="/" title="访问 WhatAKitty 的个人博客">WhatAKitty</a></p><p><span>发布时间:</span>2019年05月07日 - 23时41分</p><p><span>最后更新:</span>2019年06月23日 - 16时39分</p><p><span>原始链接:</span><a href="/JSR269插件化注解API.html" title="JSR269插件化注解API">https://xuqiang.me/JSR269插件化注解API.html</a> <span class="btn" data-clipboard-text="原文: https://xuqiang.me/JSR269插件化注解API.html　　作者: WhatAKitty" title="点击复制文章链接"><i class="fa fa-clipboard"></i></span></p><p><span>许可协议:</span><i class="fa fa-creative-commons"></i> <a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/3.0/cn/" title="中国大陆 (CC BY-NC-SA 3.0 CN)">"署名-非商用-相同方式共享 3.0"</a> 转载请保留原文链接及作者。</p></div><br><br><style type="text/css">.copyright p .btn{margin-left:1em}.copyright:hover p .btn::after{content:"复制"}.copyright p .btn:hover{color:gray;cursor:pointer}</style></div><div class="article-footer"><div class="article-meta pull-left"><span class="post-categories"><i class="icon-categories"></i> <a href="/categories/Java/">Java</a>, <a href="/categories/Java/JSR/">JSR</a> </span><span class="post-tags"><i class="icon-tags"></i> <a href="/tags/java/">java</a><a href="/tags/jsr269/">jsr269</a></span></div><script src="https://cdn.staticfile.org/mermaid/8.0.0/mermaid.min.js"></script><script>window.mermaid&&mermaid.initialize({theme:"forest"},".mermaid")</script></div><div style="text-align:center;margin-top:80px"><div id="cyReward" role="cylabs" data-use="reward" sid="589328d2fde3734215f83bc9536ae2d3" cid="1"></div></div></article><section id="comments"><script>talkyardServerUrl="https://comments-for-xuqiang-me.talkyard.net"</script><script async defer src="https://c1.ty-cdn.net/-/talkyard-comments.min.js"></script><div class="talkyard-comments" data-discussion-id="JSR269插件化注解API" style="margin-top:45px"><noscript>Please enable Javascript to view comments.</noscript></div></section></main><footer class="site-footer"><script async src="//static.xuqiang.me/busuanzi.pure.mini.js"></script><p class="site-info">Proudly powered by <a href="https://hexo.io/" target="_blank">Hexo</a> and Theme by <a href="https://github.com/CodeDaraW/Hacker" target="_blank">Hacker</a><br>&copy; 2020 WhatAKitty | <span id="busuanzi_container_site_pv">本站总访问量<span id="busuanzi_value_site_pv"></span>次</span><br><a href="https://blog.whatakitty.com">浙ICP备15019585号</a> <a target="_blank" href="http://www.beian.gov.cn/portal/registerSystemInfo?recordcode=33010602008839" style="display:block;line-height:20px"><span style="display:inline-block;line-height:20px;vertical-align:middle"><img src="https://static.xuqiang.me/public/images/beian.png" style="width:20px;height:20px"></span><span style="display:inline-block;height:20px;line-height:20px;margin:0 0 0 5px">浙公网安备 33010602008839号</span></a></p></footer><script async src="https://www.googletagmanager.com/gtag/js?id=UA-35184058-2"></script><script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","UA-35184058-2"),gtag("set",{user_id:"USER_ID"})</script></div></div></body></html>
